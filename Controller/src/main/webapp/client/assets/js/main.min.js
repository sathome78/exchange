jQuery(document).ready(function($) {

    // $('.csrfC').val($('.s_csrf').val());
    const emailPattern = new RegExp("^[\\w!#$%&'*+/=?`{|}~^-]+(?:\\.[\\w!#$%&'*+/=?`{|}~^-]+)*@(?:[a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,6}$");
    const nicknamePattern = new RegExp('^[a-zA-Z][_A-Za-z0-9\\\\-_]{2,20}$');
    const passwordPattern = new RegExp("^[a-zA-Z0-9][\\w!#$%&'*+/=?`{|}~^-]{8,20}$");

    var isEmailRight = false;
    var isNicnameRight = false;

    $('[data-fancybox]').fancybox({

        baseTpl:
    '<div class="fancybox-container">' +
        '<div class="fancybox-bg"></div>' +
        '<div class="fancybox-inner">' +
        '<div class="fancybox-stage"></div>' +
        '</div>' +
        '</div>',

        btnTpl: {
            smallBtn:
                '<div data-fancybox-close class="popup__close"></div>',
        },
        animationEffect: 'zoom-in-out',
        animationDuration: 200,
    });


    $('.js-coverbox[data-fancybox]').fancybox({

        baseTpl:
        '<div class="fancybox-container">' +
        '<div class="fb-bg"></div>' +
        '<div class="fancybox-inner">' +
        '<div class="fancybox-stage"></div>' +
        '</div>' +
        '</div>',

        btnTpl: {
            smallBtn: '',
        },
        clickSlide: false,
        clickOutside: false,
        touch: false
    });

    $('.field__input').bind('checkval',function(){
        var labelActive = 'field__label--active';
        var inputActive = 'field__input--active';

        var label = $(this).siblings('.field__label');
        if (this.value !== ''){
            $(this).addClass(inputActive);
            label.addClass(labelActive);
        } else {
            $(this).removeClass(inputActive);
            label.removeClass(labelActive);
        }
    }).on('keyup',function(){
        $(this).trigger('checkval');
    });

    $('.js-show-pwd').on('click', function() {
        var pwd = $(this).siblings('.js-pwd');
        $(this).toggleClass('field__pwd-show--active');

        if ($(pwd).attr('type') == 'password') {
            $(pwd).attr('type', 'text');
        } else {
            $(pwd).attr('type', 'password');
        }
    });

    $('[type=submit]').on('click', function () {

        var $btn  = $(this);
        var $form = $btn.closest('form');

        $form.validate({
            ignore:'',
            errorClass: 'field__error',
            errorElement: 'div',
            highlight: function(element) {
                $(element).addClass('field__input--error').siblings('.field__label').addClass('field__label--error');
            },
            unhighlight: function(element) {
                $(element).removeClass('field__input--error').siblings('.field__label').removeClass('field__label--error');
            },
            rules: {
                email: {
                    required: true,
                    email: true,
                },
                password: {
                    required: true,
                },
            },
            // submitHandler: function (form) {
            //     $btn.removeClass('btn--error');
            // },
            // invalidHandler: function(form) {
            //     $btn.addClass('btn--error');
            // }
        });

    });



    $('#forgot_pwd').on('click', function () {
        $.fancybox.close();
        $('#forgot_pwd_hide').trigger('click');
    });

    $('#back_login').on('click', function () {
        $.fancybox.close();
        $('#login_link').trigger('click');
    });

    $('#go_login').on('click', function () {
        $.fancybox.close();
        $('#login_link').trigger('click');
    });

    $('#go_to_register').on('click', function () {
        $.fancybox.close();
        $('#regT').trigger('click');
    });



    $('#login_submit').on('click', function () {
        startGeetest(loginHandler);
    });

    $('#auth_email').keyup(debounce(function(){
        checkAuthForm();
    },400));

    $('#auth_pass').keyup(debounce(function(){
        checkAuthForm();
    },400));

    $(function () {
        var error = $('#login_error').val();
        if (error) {
            $('#login_link').trigger('click');
        }
    });



    $('#email_pwd_restore').keyup(debounce(function () {
        var email = $('#email_pwd_restore');
        $('#pwd_restore_submit').prop('disabled', true);
        $('#email_pwd_restore_wrong').css('display', 'none');
        $('#email_pwd_restore_notExist').css('display', 'none');

        if (emailPattern.test(email.val())) {
            $.ajax({
                url: "/info/public/if_email_exists",
                data: {
                    email: email.val()
                },
                success: function(result){
                    if (result.length > 0) {
                        $('#pwd_restore_submit').prop('disabled', false);
                        email.removeClass('field__input--error').siblings('.field__label').removeClass('field__label--error');
                    } else {
                        email.addClass('field__input--error').siblings('.field__label').addClass('field__label--error');
                        $('#email_pwd_restore_notExist').css('display', 'block');
                        $('#pwd_restore_submit').prop('disabled', true);
                    }
                }
            });

        } else {
            email.addClass('field__input--error').siblings('.field__label').addClass('field__label--error');
            $('#email_pwd_restore_wrong').css('display', 'block');
        }
        }, 400)
    );

    $('#pwd_restore_form').submit(function (e) {
        startGeetest(restorePasswordHandler);
        e.preventDefault();
    });

    $(function () {
        var success = $('#recoveryConfirm').val();
        if (success) {
            $('#recovery_confirmed_link').trigger('click');
        }
    });



    $('#nickname').keyup(debounce(function(){
        var nickname = $('#nickname');
        var val = nickname.val();
        var wrong = $('#nichname_wrong');
        var exists = $('#nickname_exists');
        wrong.css('display', 'none');
        exists.css('display', 'none');

        if (nicknamePattern.test(val)) {
            $.ajax({
                url: "/info/public/if_username_exists",
                data: {
                    username: val
                },
                success: function (result) {
                    if (result.length > 0) {
                        formError(nickname, exists);
                        isNicnameRight = false;
                    } else {
                        nickname.removeClass('field__input--error').siblings('.field__label').removeClass('field__label--error');
                        isNicnameRight = true;
                        checkRegForm();
                    }
                }
            });
        } else {
            isNicnameRight = false;
            formError(nickname, wrong);
        }
    },400));

    $('#email').keyup(debounce(function(){
        var email = $('#email');
        var val = email.val();
        var wrong = $('#email_wrong');
        var exists = $('#email_exists');
        wrong.css('display', 'none');
        exists.css('display', 'none');

        if(emailPattern.test(val)){
            $.ajax({
                url: "/info/public/if_email_exists",
                data: {
                    email: val
                },
                success: function(result){
                    if (result.length > 0) {
                        isEmailRight = false;
                        formError(email, exists);
                    } else {
                        email.removeClass('field__input--error').siblings('.field__label').removeClass('field__label--error');
                        isEmailRight = true;
                        checkRegForm();
                    }
                }
            });
        } else {
            isEmailRight = false;
            formError(email, wrong);
        }
    },400));

    $('#password').keyup(debounce(function(){
        var pasword = $('#password');
        var val = pasword.val();
        var wrong = $('#password_wrong');
        wrong.css('display', 'none');

        if (!passwordPattern.test(val)) {
            pasword.addClass('field__input--error').siblings('.field__label').addClass('field__label--error');
            wrong.css('display', 'block');
            $("#pass_submit").prop('disabled', true);
        } else {
            pasword.removeClass('field__input--error').siblings('.field__label').removeClass('field__label--error');
            $("#pass_submit").prop('disabled', false);
        }
    },400));

    $('#create_me').submit(function(e) {
        startGeetest(createUserHandler);
        e.preventDefault();
    });

    $('#privacy__checked').change(function() {
        checkRegForm();
    });

    $(function () {
        var success = $('#successConfirm').val();
        if (success) {
            $('#reg_confirmed').trigger('click');
        }
    });



    var checkRegForm = function () {
        console.log('Checking reg....')
        var email = $('#email').val();
        var nickname = $('#nickname').val();
        if ((!$('#email')[0] || (email.length != 0)
                && (nickname.length != 0)
                && isNicnameRight
                && isEmailRight
                && $('#privacy__checked').is(":checked"))) {
            $("#reg_submit").prop('disabled', false);
        } else {
            formError();
        }
    };


});

function checkAuthForm() {
    var email = $('#auth_email').val();
    var pass = $('#auth_pass').val();
    if ((!$('#email')[0] || (email.length != 0) && (pass.length != 0))) {
        $("#login_submit").prop('disabled', false);
    } else {
        $("#login_submit").prop('disabled', true);
    }
};

function formError(element, error) {
    $(element).addClass('field__input--error').siblings('.field__label').addClass('field__label--error');
    $(error).css('display', 'block');
    $("#reg_submit").prop('disabled', true);
};

function debounce(func, wait, immediate) {
    var timeout;
    return function() {
        var context = this, args = arguments;
        var later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
    };
};


//Geetes

var loginHandler = function (captchaObj) {
    captchaObj.onSuccess(function () {
        var result = captchaObj.getValidate();
        if (!result) {
            $("#notice2").show();
            setTimeout(function () {
                $("#notice2").hide();
            }, 2000);
        } else {
            $('#log_geetest_challenge').val(result.geetest_challenge);
            $('#log_geetest_validate').val(result.geetest_validate);
            $('#log_geetest_seccode').val(result.geetest_seccode);
            $('#login_form').submit();

            setTimeout(function () {
                $('#login_form')[0].reset();
                $('.geetest_holder').remove();
                $("#wait1").css('display', 'block');
                $("#captcha_mssg").css('display', 'none');
            }, 2000);
        }
    })

    captchaObj.appendTo("#captcha1");
    captchaObj.onReady(function () {
        $("#wait1").css('display', 'none');
        $("#captcha_mssg").css('display', 'block');
    });
};

var createUserHandler = function (captchaObj) {
    captchaObj.onSuccess(function () {
        var result = captchaObj.getValidate();
        if (!result) {
            $("#notice2").show();
            setTimeout(function () {
                $("#notice2").hide();
            }, 2000);
        } else {
            $.ajax({
                type: "POST",
                url: "/createUser",
                data: {
                    _csrf: $('.s_csrf').val(),
                    nickname: $('#nickname').val(),
                    email: $('#email').val(),
                    geetest_challenge: result.geetest_challenge,
                    geetest_validate: result.geetest_validate,
                    geetest_seccode: result.geetest_seccode
                },
                success: function(data) {
                    $.fancybox.close();
                    $('#confirm_email').html(data.user.email);
                    $('#confirm-success').trigger('click');
                }
            });

            setTimeout(function () {
                $('#create_me')[0].reset();
                $('.geetest_holder').remove();
                $("#wait1").css('display', 'block');
                $("#captcha_mssg").css('display', 'none');
            }, 2000);

        }
    })

    captchaObj.appendTo("#captcha1");
    captchaObj.onReady(function () {
        $("#wait1").css('display', 'none');
        $("#captcha_mssg").css('display', 'block');
    });
};

var restorePasswordHandler = function (captchaObj) {
    captchaObj.onSuccess(function () {
        var result = captchaObj.getValidate();
        if (!result) {
            $("#notice2").show();
            setTimeout(function () {
                $("#notice2").hide();
            }, 2000);
        } else {

            $.ajax({
                type: "POST",
                url: "/forgotPassword/submit",
                data: {
                    _csrf: $('.s_csrf').val(),
                    email: $('#email_pwd_restore').val(),
                    geetest_challenge: result.geetest_challenge,
                    geetest_validate: result.geetest_validate,
                    geetest_seccode: result.geetest_seccode
                },
                success: function (data) {
                    $.fancybox.close();
                    $('#confirm_email').html(data.email);
                    $('#confirm-success').trigger('click');
                }
            });

            setTimeout(function () {
                $('#pwd_restore_form')[0].reset();
                $('.geetest_holder').remove();
                $("#wait1").css('display', 'block');
                $("#captcha_mssg").css('display', 'none');
            }, 2000);

        }
    })

    captchaObj.appendTo("#captcha1");
    captchaObj.onReady(function () {
        $("#wait1").css('display', 'none');
        $("#captcha_mssg").css('display', 'block');
    });
}

function startGeetest(handler) {
    $.fancybox.close();
    $('#geetest_confirm').trigger('click');
    $.ajax({
        url: "gt/register?t=" + (new Date()).getTime(),
        type: "get",
        dataType: "json",
        success: function (data) {
            initGeetest({
                gt: data.gt,
                challenge: data.challenge,
                new_captcha: data.new_captcha,
                offline: !data.success,
                product: "float",
                width: "100%",
                lang: "en"
            }, handler);
        }
    });
};

